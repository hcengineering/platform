version: '3.9'

# Test-only pgbouncer override.
# Usage (from tests folder):
#   docker compose -f ../dev/docker-compose.yaml -f docker-compose.purepg.yaml -f docker-compose.pgbouncer.yaml up -d
services:
  pgbouncer:
    image: edoburu/pgbouncer:latest
    depends_on:
      - postgres
    # Mount local test pgbouncer config (kept under tests/pgbouncer/)
    volumes:
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
      - tests_pgbouncer_logs:/var/log/pgbouncer
    environment:
      - PGBOUNCER_LISTEN_PORT=6433
      - PGBOUNCER_BACKENDS=postgres=postgres:5433/postgres
      - DB_HOST=postgres
      - DB_PORT=5433
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_NAME=postgres
    ports:
      - 6433:6433
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -h 127.0.0.1 -p 6433 || ps aux | grep -q pgbouncer']
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

volumes:
  tests_pgbouncer_logs:
